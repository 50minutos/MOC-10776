USE master

IF EXISTS (SELECT * FROM SYS.databases WHERE name = 'DB')
BEGIN
	ALTER DATABASE DB
	SET SINGLE_USER
	WITH ROLLBACK IMMEDIATE

	DROP DATABASE DB
END

CREATE DATABASE DB
GO

USE DB

CREATE TABLE PEDIDO
(
	COD_PEDIDO INT PRIMARY KEY, 
	DATA_PEDIDO DATE
)

CREATE TABLE ITEM_PEDIDO
(
	COD_ITEM_PEDIDO INT PRIMARY KEY IDENTITY, 
	COD_PRODUTO INT, 
	PRECO_PRODUTO DEC(9,2), 
	QTD_PRODUTO INT, 
	COD_PEDIDO INT REFERENCES PEDIDO 
		ON DELETE CASCADE
)

INSERT PEDIDO
VALUES (1, GETDATE())

INSERT ITEM_PEDIDO
VALUES (1, 10, 2, 1)

INSERT PEDIDO
VALUES (2, GETDATE())

INSERT ITEM_PEDIDO
VALUES (1, 10, 20, 2)

CREATE TABLE PRODUTO
(
	COD_PRODUTO INT IDENTITY PRIMARY KEY, 
	NOME_PRODUTO VARCHAR(50),
	PRECO_PRODUTO DEC(9, 2)
)

DECLARE @X INT = 1

WHILE @X <= 10
BEGIN 
	INSERT PRODUTO (NOME_PRODUTO)
	VALUES (NEWID())

	SET @X += 1
END

UPDATE PRODUTO
SET PRECO_PRODUTO = COD_PRODUTO * 10

GO

CREATE ASSEMBLY CLR
FROM 'C:\Users\agnaldo\Desktop\10776\CLR\CLR\bin\Debug\CLR.dll'

GO

CREATE PROC USP_ATUALIZAR_PRECO
	@CODIGOS NVARCHAR(MAX), 
	@PERCENTUAL INT
AS
	EXTERNAL NAME CLR.StoredProcedures.AtualizarPreco
GO

CREATE FUNCTION UDF_SOMAR
(
	@X INT, 
	@Y INT
)
RETURNS INT
AS
	EXTERNAL NAME CLR.UserDefinedFunctions.Somar
GO

CREATE TRIGGER UTR_PRODUTO_DELETE
ON PRODUTO
FOR DELETE
AS 
	EXTERNAL NAME [CLR].[Triggers].[Logar]
GO

SELECT *
FROM PRODUTO

EXEC SP_CONFIGURE 'clr enabled', 1
GO
RECONFIGURE

EXEC USP_ATUALIZAR_PRECO '1,4,7,8', 10

SELECT *
FROM PRODUTO

SELECT DBO.UDF_SOMAR(10, 43) AS 'SOMA'

DROP TRIGGER UTR_PRODUTO_DELETE
DROP FUNCTION UDF_SOMAR
DROP PROC USP_ATUALIZAR_PRECO
DROP ASSEMBLY CLR

DELETE PRODUTO
WHERE COD_PRODUTO = 1

DELETE PRODUTO

SELECT * 
FROM PRODUTO
